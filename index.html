<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Misiones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Scrollbar personalizado (para el body y los internos) */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; border-radius: 4px;}
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .category-card-bg {
            background-image: linear-gradient(to bottom right, #1e293b, #111827);
        }
        /* Animación de brillo para misión completada */
        .mission-completed-glow {
            animation: glow 0.8s ease-out;
        }
        @keyframes glow {
            0% { box-shadow: 0 0 0 0 rgba(34, 211, 238, 0); border-color: #0e7490; }
            50% { box-shadow: 0 0 15px 5px rgba(34, 211, 238, 0.5); border-color: #22d3ee; }
            100% { box-shadow: 0 0 0 0 rgba(34, 211, 238, 0); border-color: #0e7490; }
        }
        /* Animación para los puntos flotantes */
        .points-celebration {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: floatUp 1.2s ease-out forwards;
            pointer-events: none;
            z-index: 10;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -200%) scale(1.2); }
        }
        /* Estilo para el selector de semana en la tarjeta */
        .week-select-card {
            background-color: #334155; /* slate-700 */
            color: #cbd5e1; /* slate-300 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            border-radius: 0.25rem; /* rounded */
            padding: 0.125rem 0.25rem; /* p-0.5 px-1 */
            border: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3'/%3e%3c/svg%3e");
            background-position: right 0.25rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            padding-right: 1.75rem; /* Espacio para la flecha */
        }
        .week-select-card:focus {
            outline: none;
            box-shadow: 0 0 0 2px #06b6d4; /* focus:ring-2 focus:ring-cyan-500 */
        }
        /* Estilo para listas GES */
        #ges-realizadas-list, #ges-propuestas-list {
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.6;
        }
    </style>
</head>
<body class="bg-slate-900 text-white p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-white tracking-tight">IODI</h1>
            <p class="mt-2 text-lg text-slate-400">Panel de Misiones</p>
             <div class="relative mt-6 inline-block">
                <div class="absolute -inset-1.5 bg-gradient-to-r from-cyan-500 to-emerald-500 rounded-xl blur opacity-50"></div>
                <div class="relative bg-slate-800/80 backdrop-blur-sm border border-cyan-500/20 py-4 px-8 rounded-xl shadow-2xl text-center">
                    <p class="text-sm font-medium text-cyan-200 uppercase tracking-widest">Puntaje Total</p>
                    <p id="total-score" class="text-4xl text-white tracking-tighter mt-1">0</p>
                    <div class="my-4 border-t border-slate-700/50"></div>
                    <div id="stats-container" class="grid grid-cols-3 gap-4 sm:gap-6">
                        <div class="text-center">
                            <!-- ID actualizado para colorear -->
                            <p id="completed-missions-count" class="text-1xl text-white">0</p>
                            <p class="text-xs text-slate-400 uppercase tracking-wider">Misiones Hechas</p>
                        </div>
                        <div class="text-center">
                            <!-- ID actualizado para colorear -->
                            <p id="proposed-automissions-count" class="text-1xl text-white">0</p>
                            <p class="text-xs text-slate-400 uppercase tracking-wider">Autom. Propuestas</p>
                        </div>
                        <div class="text-center">
                            <!-- ID actualizado para colorear -->
                            <p id="completed-automissions-count" class="text-1xl text-white">0</p>
                            <p class="text-xs text-slate-400 uppercase tracking-wider">Autom. Hechas</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <section class="mb-6 fade-in">
            <div class="bg-slate-800 rounded-xl shadow-lg p-6 border border-slate-700">
                <div class="flex flex-wrap gap-4 items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-cyan-400">Añadir Misión</h2>
                    <button id="manage-categories-btn" class="text-sm bg-slate-700 hover:bg-slate-600 text-slate-300 font-semibold py-2 px-4 rounded-lg transition-colors duration-300">
                        <i class="fas fa-folder-plus mr-2"></i>Gestionar Categorías
                    </button>
                </div>
                <!-- Formulario reorganizado a 6 columnas -->
                <form id="add-mission-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
                    <!-- Fila 1 -->
                    <div class="lg:col-span-3">
                        <label for="mission-code" class="block text-sm font-medium text-slate-400 mb-1">Código (Único)</label>
                        <input type="text" id="mission-code" name="mission-code" required class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ej: 251002_1217 [+80]">
                    </div>
                     <div class="lg:col-span-3">
                        <label for="mission-name" class="block text-sm font-medium text-slate-400 mb-1">Nombre (Opcional)</label>
                        <input type="text" id="mission-name" name="mission-name" class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ej: Modelado de Asientos">
                    </div>
                    <!-- Fila 2 -->
                    <div class="lg:col-span-2">
                        <label for="mission-points" class="block text-sm font-medium text-slate-400 mb-1">Puntos</label>
                        <input type="number" id="mission-points" name="mission-points" required min="1" class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ej: 80">
                    </div>
                     <div class="lg:col-span-2">
                        <label for="mission-week" class="block text-sm font-medium text-slate-400 mb-1">Semana</label>
                        <select id="mission-week" name="mission-week" required class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 h-10">
                            <option value="" disabled selected>Elegir</option>
                        </select>
                    </div>
                    <div class="lg:col-span-1">
                        <label for="mission-type" class="block text-sm font-medium text-slate-400 mb-1">Tipo</label>
                        <select id="mission-type" name="mission-type" required class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 h-10">
                            <option value="mision">Misión</option>
                            <option value="automision">Automisión</option>
                        </select>
                    </div>
                    <div class="lg:col-span-1">
                        <label for="mission-category" class="block text-sm font-medium text-slate-400 mb-1">Software</label>
                        <select id="mission-category" name="mission-category" required class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 h-10"></select>
                    </div>
                    <!-- Botón -->
                    <button type="submit" class="sm:col-span-2 lg:col-span-6 w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 h-10 mt-4">Añadir Misión</button>
                </form>
            </div>
        </section>
        
        <section class="mb-8 fade-in">
            <div class="bg-slate-800 rounded-xl shadow-lg p-6 border border-slate-700">
                <div id="filter-header" class="flex justify-between items-center cursor-pointer">
                    <h2 class="text-2xl font-bold text-cyan-400">Filtrar Misiones</h2>
                    <button id="filter-toggle-button" class="text-slate-400 hover:text-cyan-400 transition-colors duration-200"></button>
                </div>
                <div id="filter-content" class="mt-4 pt-4 border-t border-slate-700">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div>
                            <label for="search-input" class="block text-sm font-medium text-slate-400 mb-2">Buscar por Código o Nombre</label>
                            <input type="text" id="search-input" placeholder="Buscar misión..." class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                        </div>
                        <div>
                            <label for="filter-week" class="block text-sm font-medium text-slate-400 mb-2">Filtrar por Semana</label>
                            <select id="filter-week" name="filter-week" class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 h-10">
                                <option value="all">Todas las semanas</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-2">Filtrar por Estado</label>
                            <div class="flex flex-wrap gap-2">
                                <button data-filter="all" class="filter-button bg-cyan-600 hover:bg-cyan-700 text-white text-sm font-medium py-1.5 px-3 rounded-full transition-colors duration-200">Todas</button>
                                <button data-filter="completed" class="filter-button bg-slate-600 hover:bg-slate-500 text-slate-300 text-sm font-medium py-1.5 px-3 rounded-full transition-colors duration-200">Realizadas</button>
                                <button data-filter="pending" class="filter-button bg-slate-600 hover:bg-slate-500 text-slate-300 text-sm font-medium py-1.5 px-3 rounded-full transition-colors duration-200">Pendientes</button>
                                <button data-filter="proposed" class="filter-button bg-slate-600 hover:bg-slate-500 text-slate-300 text-sm font-medium py-1.5 px-3 rounded-full transition-colors duration-200">Propuestas</button>
                            </div>
                        </div>
                        <!-- Filtro GES añadido -->
                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-2">Filtrar por GES</label>
                            <div class="flex flex-wrap gap-2">
                                <button data-filter-ges="all" class="ges-filter-button bg-cyan-600 hover:bg-cyan-700 text-white text-sm font-medium py-1.5 px-3 rounded-full transition-colors duration-200">Todos (GES)</button>
                                <button data-filter-ges="sent" class="ges-filter-button bg-slate-600 hover:bg-slate-500 text-slate-300 text-sm font-medium py-1.5 px-3 rounded-full transition-colors duration-200">Enviados</button>
                                <button data-filter-ges="not-sent" class="ges-filter-button bg-slate-600 hover:bg-slate-500 text-slate-300 text-sm font-medium py-1.5 px-3 rounded-full transition-colors duration-200">No Enviados</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Nueva Tarjeta "Enviar al GES" -->
        <section id="ges-summary-card" class="mb-8 fade-in">
            <div class="category-card-bg rounded-xl shadow-lg p-6 border border-cyan-700">
                <div class="flex justify-between items-center mb-4 border-b border-cyan-600/50 pb-3">
                    <h2 class="text-2xl font-bold text-cyan-400">Enviar al GES</h2>
                    <i class="fas fa-paper-plane text-cyan-400 text-xl"></i>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <!-- Botón de Copiar Añadido -->
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-lg font-semibold text-white">Realizadas (Misiones y Autom.)</h4>
                            <button id="copy-realizadas-btn" class="text-xs bg-slate-600 hover:bg-slate-500 text-slate-300 font-medium py-1 px-3 rounded-full transition-all duration-200">
                                <i class="fas fa-copy mr-1"></i> Copiar
                            </button>
                        </div>
                        <div id="ges-realizadas-list" class="text-slate-300 text-sm font-mono bg-slate-800/50 p-3 rounded-lg min-h-[40px]">
                            <!-- Contenido generado por JS -->
                        </div>
                    </div>
                    <div>
                        <!-- Botón de Copiar Añadido -->
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-lg font-semibold text-white">Propuestas (Automisiones)</h4>
                            <button id="copy-propuestas-btn" class="text-xs bg-slate-600 hover:bg-slate-500 text-slate-300 font-medium py-1 px-3 rounded-full transition-all duration-200">
                                <i class="fas fa-copy mr-1"></i> Copiar
                            </button>
                        </div>
                        <div id="ges-propuestas-list" class="text-slate-300 text-sm font-mono bg-slate-800/50 p-3 rounded-lg min-h-[40px]">
                            <!-- Contenido generado por JS -->
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <main id="categories-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></main>

        <footer class="text-center mt-12">
            <button id="reset-button" class="bg-red-900/50 hover:bg-red-900/80 text-red-300 font-semibold py-2 px-5 rounded-lg transition-colors duration-300">
                Reiniciar Progreso
            </button>
        </footer>
    </div>
    
    <!-- Modal para gestionar categorías -->
    <div id="category-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-slate-800 rounded-xl shadow-lg p-6 border border-slate-700 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-cyan-400">Gestionar Categorías</h3>
                <button id="close-modal-btn" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-2">Añadir Nueva Categoría</h4>
                <form id="add-category-form" class="flex gap-2">
                    <input type="text" id="new-category-name" placeholder="Nombre del software" class="flex-grow bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                    <button type="submit" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">Añadir</button>
                </form>
            </div>
            <div>
                <h4 class="text-lg font-semibold text-white mb-2">Categorías Existentes</h4>
                <ul id="category-list" class="space-y-2 max-h-60 overflow-y-auto"></ul>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALES Y DATOS ---
        const initialMissionData = { "Blender": [], "Figma": [], "SolidWorks": [] };
        let missionData;
        let categoryCollapseStates = JSON.parse(localStorage.getItem('categoryCollapseStates')) || {};
        let isFilterCollapsed = JSON.parse(localStorage.getItem('isFilterCollapsed')) || false;
        let currentFilter = { text: '', status: 'all', week: 'all', ges: 'all' };
        // Metas para colorear contadores
        const metaHechas = 15;
        const metaPropuestas = 5;

        // --- FUNCIONES DE DATOS ---
        function loadProgress() {
            const savedData = localStorage.getItem('missionProgressData');
            missionData = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(initialMissionData));
            if (Object.keys(missionData).length === 0) {
                 missionData = JSON.parse(JSON.stringify(initialMissionData));
            }
        }

        function saveProgress() {
            localStorage.setItem('missionProgressData', JSON.stringify(missionData));
            localStorage.setItem('categoryCollapseStates', JSON.stringify(categoryCollapseStates));
            localStorage.setItem('isFilterCollapsed', JSON.stringify(isFilterCollapsed));
        }

        // --- FUNCIONES DE RENDERIZADO ---
        function animateScore(start, end) {
            const scoreElement = document.getElementById('total-score');
            if (start === end) {
                scoreElement.textContent = end;
                return;
            }
            const duration = 800;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.max(1, Math.abs(Math.floor(duration / range)));

            const timer = setInterval(() => {
                current += increment;
                scoreElement.textContent = current;
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        function updateScoresAndStats(animate = false, oldScore = 0) {
            const totalScoreElement = document.getElementById('total-score');
            const completedMissionsElement = document.getElementById('completed-missions-count');
            const proposedAutoMissionsElement = document.getElementById('proposed-automissions-count');
            const completedAutoMissionsElement = document.getElementById('completed-automissions-count');

            let totalPoints = 0, completedMissions = 0, proposedAutoMissions = 0, completedAutoMissions = 0;

            Object.values(missionData).flat().forEach(mission => {
                if (mission.type === 'mision') {
                    if (mission.completed) {
                        completedMissions++;
                        totalPoints += mission.points;
                    }
                } else if (mission.type === 'automision') {
                    if (mission.status?.proposed) proposedAutoMissions++;
                    if (mission.status?.completed) completedAutoMissions++;
                    if (mission.status?.proposed || mission.status?.completed) {
                        totalPoints += mission.points;
                    }
                }
            });

            if (animate) {
                animateScore(oldScore, totalPoints);
            } else {
                totalScoreElement.textContent = totalPoints;
            }
            
            completedMissionsElement.textContent = completedMissions;
            proposedAutoMissionsElement.textContent = proposedAutoMissions;
            completedAutoMissionsElement.textContent = completedAutoMissions;

            // --- Lógica de color para metas ---
            const totalHechas = completedMissions + completedAutoMissions;
            const totalPropuestas = proposedAutoMissions;

            // Resetear clases
            [completedMissionsElement, proposedAutoMissionsElement, completedAutoMissionsElement].forEach(el => {
                el.classList.remove('text-red-400', 'text-green-400');
            });

            // Aplicar clases para Misiones Hechas (combinadas)
            if (totalHechas < metaHechas) {
                completedMissionsElement.classList.add('text-red-400');
                completedAutoMissionsElement.classList.add('text-red-400');
            } else {
                completedMissionsElement.classList.add('text-green-400');
                completedAutoMissionsElement.classList.add('text-green-400');
            }

            // Aplicar clases para Automisiones Propuestas
            if (totalPropuestas < metaPropuestas) {
                proposedAutoMissionsElement.classList.add('text-red-400');
            } else {
                proposedAutoMissionsElement.classList.add('text-green-400');
            }
        }
        
        function renderGESSummary() {
            const realizadasListEl = document.getElementById('ges-realizadas-list');
            const propuestasListEl = document.getElementById('ges-propuestas-list');
            
            let realizadas = [];
            let propuestas = [];

            const allMissions = Object.values(missionData).flat();

            allMissions.forEach(mission => {
                if (!mission.sentToGES) {
                    if ((mission.type === 'mision' && mission.completed) || (mission.type === 'automision' && mission.status?.completed)) {
                        realizadas.push(mission.codigo); 
                    }
                    if (mission.type === 'automision' && mission.status?.proposed) {
                        propuestas.push(mission.codigo);
                    }
                }
            });

            realizadasListEl.innerHTML = realizadas.length > 0 ? realizadas.join('; ') : '<span class="text-slate-500 italic">Nada para enviar</span>';
            propuestasListEl.innerHTML = propuestas.length > 0 ? propuestas.join('; ') : '<span class="text-slate-500 italic">Nada para enviar</span>';
        }

        function renderMissions() {
            const container = document.getElementById('categories-container');
            container.innerHTML = ''; 

            Object.keys(missionData).sort().forEach(category => {
                const isCollapsed = categoryCollapseStates[category] || false;
                const categoryCard = document.createElement('div');
                // --- CORRECCIÓN: Quitado 'fade-in' de aquí ---
                categoryCard.className = 'category-card-bg rounded-xl shadow-lg p-6 border border-slate-700 flex flex-col';

                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'flex justify-between items-center mb-4 border-b border-slate-600 pb-3 cursor-pointer';
                categoryHeader.dataset.category = category;
                categoryHeader.innerHTML = `
                    <h2 class="text-2xl font-bold text-cyan-400">${category}</h2>
                    <button class="text-slate-400 hover:text-cyan-400 transition-colors duration-200">
                        ${isCollapsed ? '<i class="fas fa-chevron-down text-lg"></i>' : '<i class="fas fa-chevron-up text-lg"></i>'}
                    </button>
                `;
                categoryCard.appendChild(categoryHeader);

                const missionList = document.createElement('ul');
                missionList.className = `space-y-4 ${isCollapsed ? 'hidden' : ''} max-h-96 overflow-y-auto pr-2`;

                const filteredMissions = missionData[category].filter(mission => {
                    const search_text = currentFilter.text.toLowerCase();
                    const matchesText = mission.codigo.toLowerCase().includes(search_text) || (mission.nombre && mission.nombre.toLowerCase().includes(search_text));
                    
                    let matchesStatus = true;
                    if (currentFilter.status === 'completed') matchesStatus = (mission.type === 'mision' && mission.completed) || (mission.type === 'automision' && mission.status?.completed);
                    else if (currentFilter.status === 'pending') matchesStatus = (mission.type === 'mision' && !mission.completed) || (mission.type === 'automision' && !mission.status?.completed);
                    else if (currentFilter.status === 'proposed') matchesStatus = mission.type === 'automision' && mission.status?.proposed;
                    
                    const matchesWeek = currentFilter.week === 'all' || mission.semana == currentFilter.week;
                    
                    const matchesGES = currentFilter.ges === 'all' || 
                                     (currentFilter.ges === 'sent' && mission.sentToGES) || 
                                     (currentFilter.ges === 'not-sent' && !mission.sentToGES);

                    return matchesText && matchesStatus && matchesWeek && matchesGES;
                });

                filteredMissions.sort((a, b) => parseInt(a.semana, 10) - parseInt(b.semana, 10));

                if (filteredMissions.length === 0) {
                    missionList.innerHTML = '<p class="text-slate-500 italic py-2">No hay misiones que coincidan con el filtro.</p>';
                } else {
                    filteredMissions.forEach(mission => {
                        const missionItem = document.createElement('li');
                        missionItem.dataset.codigo = mission.codigo; 
                        missionItem.className = 'group relative p-4 bg-slate-800/50 rounded-lg border border-slate-700 hover:shadow-lg hover:border-cyan-600 transition-all duration-300 ease-in-out transform hover:scale-[1.01]';
                        
                        const missionIconClass = mission.type === 'mision' ? 'fas fa-book text-emerald-400' : 'fas fa-lightbulb text-purple-400';
                        const missionNameDisplay = mission.nombre ? `<span class="text-slate-400 ml-1">(${mission.nombre})</span>` : '';

                        let weekOptions = '';
                        for (let i = 1; i <= 15; i++) {
                            weekOptions += `<option value="${i}" ${mission.semana == i ? 'selected' : ''}>Semana ${i}</option>`;
                        }
                        const weekSelector = `<select class="week-select-card" data-action="change-week">${weekOptions}</select>`;

                        // --- Botones de Estado (con colores actualizados) ---
                        let statusButtonsHTML = '';
                        const pendingClasses = 'bg-amber-600 text-amber-100 hover:bg-amber-500'; // Naranja para pendiente
                        const completedClasses = 'bg-emerald-700 text-emerald-100 hover:bg-emerald-600'; // Verde para completado
                        
                        if (mission.type === 'automision') {
                            const proposedClasses = 'bg-sky-700 text-sky-100 hover:bg-sky-600'; // Azul para propuesta
                            statusButtonsHTML = `
                                <button data-status-type="proposed" class="text-xs font-bold py-1 px-3 rounded-full transition-colors duration-300 ${mission.status?.proposed ? proposedClasses : pendingClasses}">
                                    ${mission.status?.proposed ? 'Propuesta' : 'No Propuesta'}
                                </button>
                                <button data-status-type="completed" class="text-xs font-bold py-1 px-3 rounded-full transition-colors duration-300 ${mission.status?.completed ? completedClasses : pendingClasses}">
                                    ${mission.status?.completed ? 'Realizada' : 'Pendiente'}
                                </button>
                            `;
                        } else {
                            statusButtonsHTML = `
                                <button data-status-type="completed" class="text-xs font-bold py-1 px-3 rounded-full transition-colors duration-300 ${mission.completed ? completedClasses : pendingClasses}">
                                    ${mission.completed ? 'Realizado' : 'Pendiente'}
                                </button>
                            `;
                        }
                        // Botón de GES
                        const gesSentClasses = 'bg-indigo-700 text-indigo-100 hover:bg-indigo-600'; // Morado para enviado
                        statusButtonsHTML += `
                            <button data-status-type="ges" class="text-xs font-bold py-1 px-3 rounded-full transition-colors duration-300 ${mission.sentToGES ? gesSentClasses : pendingClasses}">
                                ${mission.sentToGES ? 'Enviado GES' : 'No Enviado'}
                            </button>
                        `;

                        missionItem.innerHTML = `
                            <div class="absolute top-3 right-3 flex gap-3 opacity-0 group-hover:opacity-100 transition-all duration-300">
                                <button data-action="toggle-note" class="transition-colors duration-200 ${mission.note ? 'text-amber-400 hover:text-amber-300' : 'text-slate-500 hover:text-slate-300'}">
                                    <i class="fas fa-note-sticky"></i>
                                </button>
                                <button data-action="delete" class="text-slate-500 hover:text-red-500 transition-all duration-300">
                                    <i class="fas fa-trash-alt text-base"></i>
                                </button>
                            </div>
                            <div class="pr-14">
                                <div class="flex items-center gap-2 mb-1">
                                    <i class="${missionIconClass} text-lg"></i>
                                    <span class="font-semibold text-white leading-tight block">${mission.codigo}</span>
                                    ${missionNameDisplay}
                                </div>
                                <div class="flex items-center gap-3 mt-1">
                                    <span class="text-amber-400 text-sm font-medium">+${mission.points} pts</span>
                                    ${weekSelector}
                                </div>
                            </div>
                            <div class="flex items-center flex-wrap gap-2 mt-3">
                                ${statusButtonsHTML}
                            </div>
                            <div class="hidden mt-3" data-note-editor>
                                <textarea class="w-full bg-slate-900 text-white border-slate-600 rounded-lg p-2 text-sm" rows="3" placeholder="Añade un link o tus pensamientos...">${mission.note || ''}</textarea>
                                <button data-action="save-note" class="mt-2 text-xs bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-1 px-3 rounded-full">Guardar Nota</button>
                            </div>
                        `;
                        missionList.appendChild(missionItem);
                    });
                }
                categoryCard.appendChild(missionList);
                container.appendChild(categoryCard);
            });
            updateScoresAndStats();
            renderGESSummary();
        }

        function populateCategorySelector() {
            const selector = document.getElementById('mission-category');
            const currentVal = selector ? selector.value : null;
            selector.innerHTML = '<option value="" disabled>Elige un software</option>';
            Object.keys(missionData).sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                selector.appendChild(option);
            });
            if (currentVal && missionData[currentVal]) {
                selector.value = currentVal;
            } else {
                selector.selectedIndex = 0;
            }
        }

        function populateWeekSelectors() {
            const selectors = [document.getElementById('mission-week'), document.getElementById('filter-week')];
            selectors.forEach((selector, index) => {
                if (!selector) return; 
                const currentVal = selector.value;
                if (index === 0) { 
                    selector.innerHTML = '<option value="" disabled selected>Elegir</option>';
                } else { 
                    selector.innerHTML = '<option value="all">Todas las semanas</option>';
                }
                for (let i = 1; i <= 15; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Semana ${i}`;
                    selector.appendChild(option);
                }
                selector.value = currentVal;
                if(!selector.value) selector.selectedIndex = 0;
            });
        }

        function setupFilterCollapse() {
            const filterHeader = document.getElementById('filter-header');
            const filterContent = document.getElementById('filter-content');
            const filterToggleButton = document.getElementById('filter-toggle-button');
            function updateFilterView() {
                filterContent.classList.toggle('hidden', isFilterCollapsed);
                filterToggleButton.innerHTML = isFilterCollapsed ? '<i class="fas fa-chevron-down text-lg"></i>' : '<i class="fas fa-chevron-up text-lg"></i>';
            }
            updateFilterView();
            filterHeader.addEventListener('click', () => { isFilterCollapsed = !isFilterCollapsed; saveProgress(); updateFilterView(); });
        }
        
        function copyTextToClipboard(text, buttonElement) {
            if (!text || text.includes('Nada para enviar')) {
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = 'Nada';
                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                }, 1500);
                return;
            }
            const textArea = document.createElement("textarea");
            textArea.value = text.replace(/; /g, '\n'); 
            textArea.style.position = "fixed";
            textArea.style.top = 0;
            textArea.style.left = 0;
            textArea.style.opacity = 0;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            let originalButtonText;
            try {
                document.execCommand('copy');
                originalButtonText = buttonElement.innerHTML;
                buttonElement.innerHTML = '<i class="fas fa-check mr-1"></i> Copiado';
                buttonElement.classList.add('bg-emerald-600');
                buttonElement.classList.remove('bg-slate-600', 'hover:bg-slate-500');
                setTimeout(() => {
                    buttonElement.innerHTML = originalButtonText;
                    buttonElement.classList.remove('bg-emerald-600');
                    buttonElement.classList.add('bg-slate-600', 'hover:bg-slate-500');
                }, 2000);
            } catch (err) {
                console.error('Fallback: No se pudo copiar', err);
            }
            document.body.removeChild(textArea);
        }

        // --- INICIALIZACIÓN Y EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Definir variables de elementos ---
            const modal = document.getElementById('category-modal');
            const manageCategoriesBtn = document.getElementById('manage-categories-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const addCategoryForm = document.getElementById('add-category-form');
            const categoryList = document.getElementById('category-list');
            const categoriesContainer = document.getElementById('categories-container');
            const resetButton = document.getElementById('reset-button');
            const addMissionForm = document.getElementById('add-mission-form');
            const searchInput = document.getElementById('search-input');
            const filterWeek = document.getElementById('filter-week');
            const copyRealizadasBtn = document.getElementById('copy-realizadas-btn');
            const copyPropuestasBtn = document.getElementById('copy-propuestas-btn');

            // --- Carga inicial ---
            loadProgress();
            populateWeekSelectors(); 
            populateCategorySelector(); 
            renderMissions();
            setupFilterCollapse();
            
            // --- Activar filtros por defecto ---
            document.querySelector('.filter-button[data-filter="all"]')?.classList.replace('bg-slate-600', 'bg-cyan-600');
            document.querySelector('.filter-button[data-filter="all"]')?.classList.replace('text-slate-300', 'text-white');
            document.querySelector('.ges-filter-button[data-filter-ges="all"]')?.classList.replace('bg-slate-600', 'bg-cyan-600');
            document.querySelector('.ges-filter-button[data-filter-ges="all"]')?.classList.replace('text-slate-300', 'text-white');
        
            // --- Listeners para Copiar ---
            copyRealizadasBtn.addEventListener('click', (e) => {
                const text = document.getElementById('ges-realizadas-list').textContent;
                copyTextToClipboard(text, e.currentTarget);
            });
            copyPropuestasBtn.addEventListener('click', (e) => {
                const text = document.getElementById('ges-propuestas-list').textContent;
                copyTextToClipboard(text, e.currentTarget);
            });

            // --- GESTIÓN DE CATEGORÍAS (MODAL) ---
            function renderCategoryList() {
                categoryList.innerHTML = '';
                Object.keys(missionData).sort().forEach(cat => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-slate-700 p-2 rounded-lg';
                    li.innerHTML = `<span>${cat}</span><button data-cat-delete="${cat}" class="text-red-500 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>`;
                    categoryList.appendChild(li);
                });
            }
            
            manageCategoriesBtn.addEventListener('click', () => { modal.classList.remove('hidden'); renderCategoryList(); });
            closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
            
            addCategoryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('new-category-name');
                const newName = input.value.trim();
                if (newName && !missionData[newName]) {
                    missionData[newName] = [];
                    saveProgress();
                    renderCategoryList();
                    populateCategorySelector();
                    renderMissions();
                    input.value = '';
                } else { alert('El nombre de la categoría no es válido o ya existe.'); }
            });
            
            categoryList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('button[data-cat-delete]');
                if (deleteBtn) {
                    const catToDelete = deleteBtn.dataset.catDelete;
                    if (confirm(`¿Seguro que quieres eliminar la categoría "${catToDelete}" y todas sus misiones?`)) {
                        delete missionData[catToDelete];
                        delete categoryCollapseStates[catToDelete];
                        saveProgress();
                        renderCategoryList();
                        populateCategorySelector();
                        renderMissions();
                    }
                }
            });

            // --- MANEJADORES DE EVENTOS PRINCIPALES ---
            
            categoriesContainer.addEventListener('change', function(e) {
                if (e.target.dataset.action === 'change-week') {
                    const selector = e.target;
                    const missionItem = selector.closest('li');
                    const codigo = missionItem.dataset.codigo;
                    const category = missionItem.closest('.category-card-bg').querySelector('[data-category]').dataset.category;
                    
                    const realIndex = missionData[category].findIndex(m => m.codigo === codigo);

                    if (realIndex !== -1) {
                        const newWeek = parseInt(selector.value, 10);
                        missionData[category][realIndex].semana = newWeek;
                        saveProgress();
                        renderMissions();
                    } else {
                        console.error("No se pudo encontrar el índice real de la misión para cambiar semana.");
                    }
                }
            });

            categoriesContainer.addEventListener('click', function(e) {
                if (e.target.dataset.action === 'change-week') return; 

                const clickable = e.target.closest('button, div[data-category]');
                if (!clickable) return;

                const missionItem = clickable.closest('li');
                
                if (clickable.dataset.category && !missionItem) {
                    categoryCollapseStates[clickable.dataset.category] = !categoryCollapseStates[clickable.dataset.category];
                    saveProgress(); renderMissions(); return;
                }

                if (!missionItem) return;

                const codigo = missionItem.dataset.codigo;
                const category = missionItem.closest('.category-card-bg').querySelector('[data-category]').dataset.category;
                const originalIndex = missionData[category].findIndex(m => m.codigo === codigo);
                
                if (originalIndex === -1) {
                    console.error("No se pudo encontrar el índice original de la misión.");
                    return; 
                }

                const mission = missionData[category][originalIndex];
                const action = clickable.dataset.action;
                
                if (action === 'toggle-note') {
                    missionItem.querySelector('div[data-note-editor]').classList.remove('hidden');
                    clickable.classList.add('hidden'); 
                } else if (action === 'save-note') {
                    const textarea = missionItem.querySelector('textarea');
                    mission.note = textarea.value;
                    saveProgress();
                    textarea.parentElement.classList.add('hidden');
                    missionItem.querySelector('button[data-action="toggle-note"]').classList.remove('hidden'); 
                    renderMissions(); 
                } 
                else if (action === 'delete') {
                    if (confirm(`¿Seguro que quieres eliminar la misión "${mission.codigo}"?`)) {
                        missionData[category].splice(originalIndex, 1);
                        saveProgress(); renderMissions();
                    }
                } 
                else if (clickable.dataset.statusType) {
                    const oldScore = parseInt(document.getElementById('total-score').textContent, 10);
                    const type = clickable.dataset.statusType;
                    let missionJustCompleted = false;
                    let missionJustProposed = false; 

                    if (type === 'ges') {
                        mission.sentToGES = !mission.sentToGES;
                    } else if (mission.type === 'automision') {
                        if (type === 'completed' && !mission.status[type]) missionJustCompleted = true; 
                        if (type === 'proposed' && !mission.status[type]) missionJustProposed = true; 
                        mission.status[type] = !mission.status[type];
                    } else if (mission.type === 'mision' && type === 'completed') {
                        if (!mission.completed) missionJustCompleted = true; 
                        mission.completed = !mission.completed;
                    }
                    
                    saveProgress();
                    updateScoresAndStats(true, oldScore);
                    
                    // --- CORRECCIÓN: Lógica de refresco ---
                    if (missionJustCompleted || missionJustProposed) {
                        // Si hay animación, añadir clases y refrescar después del delay
                        const pointsCelebration = document.createElement('span');
                        pointsCelebration.className = 'points-celebration text-amber-300 font-bold text-lg';
                        pointsCelebration.textContent = `+${mission.points}`;
                        missionItem.appendChild(pointsCelebration);
                        missionItem.classList.add('mission-completed-glow'); 
                        setTimeout(() => pointsCelebration.remove(), 1200);
                        setTimeout(() => missionItem.classList.remove('mission-completed-glow'), 800);
                        
                        setTimeout(renderMissions, 1300); // Refrescar después de la animación
                    } else {
                        // Si NO hay animación (clic en "Pendiente", "No Enviado", etc.), 
                        // refrescar inmediatamente.
                        renderMissions();
                    }
                }
            });
            
            resetButton.addEventListener('click', () => {
                if (confirm('¿Seguro? Se borrará todo tu progreso.')) {
                    localStorage.clear();
                    loadProgress();
                    categoryCollapseStates = {};
                    isFilterCollapsed = false;
                    renderMissions();
                    setupFilterCollapse();
                    populateWeekSelectors(); 
                    populateCategorySelector(); 
                }
            });
            
            addMissionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                const codigo = form.elements['mission-code'].value.trim();
                const nombre = form.elements['mission-name'].value.trim();
                const points = parseInt(form.elements['mission-points'].value, 10);
                const semana = parseInt(form.elements['mission-week'].value, 10);
                const type = form.elements['mission-type'].value;
                const category = form.elements['mission-category'].value;

                const isDuplicate = Object.values(missionData).flat().some(m => m.codigo === codigo);
                if (isDuplicate) {
                    alert('Error: El "Código" de la misión ya existe. Debe ser único.');
                    return;
                }

                if (codigo && points > 0 && semana && category && type) {
                    const newMission = { codigo, nombre, points, semana, type, note: '', sentToGES: false };
                    if (type === 'automision') newMission.status = { proposed: false, completed: false };
                    else newMission.completed = false;
                    
                    missionData[category].push(newMission);
                    saveProgress();
                    renderMissions();
                    
                    const selectedCategory = form.elements['mission-category'].value;
                    form.reset();
                    form.elements['mission-category'].value = selectedCategory;
                } else { alert('Completa todos los campos obligatorios (Código, Puntos, Semana, Tipo, Software).'); }
            });
            
            // --- FILTROS ---
            searchInput.addEventListener('input', (e) => { currentFilter.text = e.target.value; renderMissions(); });
            
            filterWeek.addEventListener('input', (e) => {
                currentFilter.week = e.target.value;
                renderMissions();
            });

            document.querySelectorAll('.filter-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelector('.filter-button.bg-cyan-600')?.classList.replace('bg-cyan-600', 'bg-slate-600');
                    document.querySelector('.filter-button.text-white')?.classList.replace('text-white', 'text-slate-300');
                    e.target.classList.replace('bg-slate-600', 'bg-cyan-600');
                    e.target.classList.replace('text-slate-300', 'text-white');
                    currentFilter.status = e.target.dataset.filter;
                    renderMissions();
                });
            });

            document.querySelectorAll('.ges-filter-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelector('.ges-filter-button.bg-cyan-600')?.classList.replace('bg-cyan-600', 'bg-slate-600');
                    document.querySelector('.ges-filter-button.text-white')?.classList.replace('text-white', 'text-slate-300');
                    e.target.classList.replace('bg-slate-600', 'bg-cyan-600');
                    e.target.classList.replace('text-slate-300', 'text-white');
                    currentFilter.ges = e.target.dataset.filterGes;
                    renderMissions();
                });
            });

        });
    </script>
</body>
</html>

