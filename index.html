<!DOCTYPE html>
<html lang="es" class="dark">
<link rel="stylesheet" href="css/estilos.css">
<script src="js/main.js" defer></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Misiones</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Scrollbar personalizado (para el body y los internos) */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; border-radius: 4px;}
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .category-card-bg {
            background-image: linear-gradient(to bottom right, #1e293b, #111827);
        }
        /* Animación de brillo para misión completada */
        .mission-completed-glow {
            animation: glow 0.8s ease-out;
        }
        @keyframes glow {
            0% { box-shadow: 0 0 0 0 rgba(34, 211, 238, 0); border-color: #0e7490; }
            50% { box-shadow: 0 0 15px 5px rgba(34, 211, 238, 0.5); border-color: #22d3ee; }
            100% { box-shadow: 0 0 0 0 rgba(34, 211, 238, 0); border-color: #0e7490; }
        }
        /* Animación para los puntos flotantes */
        .points-celebration {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: floatUp 1.2s ease-out forwards;
            pointer-events: none;
            z-index: 10;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -200%) scale(1.2); }
        }
        /* Estilo para el selector de semana en la tarjeta */
        .week-select-card {
            background-color: #334155; /* slate-700 */
            color: #cbd5e1; /* slate-300 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            border-radius: 0.25rem; /* rounded */
            padding: 0.125rem 0.25rem; /* p-0.5 px-1 */
            border: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3'/%3e%3c/svg%3e");
            background-position: right 0.25rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            padding-right: 1.75rem; /* Espacio para la flecha */
        }
        .week-select-card:focus {
            outline: none;
            box-shadow: 0 0 0 2px #06b6d4; /* focus:ring-2 focus:ring-cyan-500 */
        }
    </style>
</head>
<body class="bg-slate-900 text-white p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-white tracking-tight">IODI</h1>
            <p class="mt-2 text-lg text-slate-400">Panel de Misiones</p>
             <div class="relative mt-6 inline-block">
                <div class="absolute -inset-1.5 bg-gradient-to-r from-cyan-500 to-emerald-500 rounded-xl blur opacity-50"></div>
                <div class="relative bg-slate-800/80 backdrop-blur-sm border border-cyan-500/20 py-4 px-8 rounded-xl shadow-2xl text-center">
                    <p class="text-sm font-medium text-cyan-200 uppercase tracking-widest">Puntaje Total</p>
                    <p id="total-score" class="text-4xl text-white tracking-tighter mt-1">0</p>
                    <div class="my-4 border-t border-slate-700/50"></div>
                    <div id="stats-container" class="grid grid-cols-3 gap-4 sm:gap-6">
                        <div class="text-center">
                            <p id="completed-missions-count" class="text-1xl text-white">0</p>
                            <p class="text-xs text-slate-400 uppercase tracking-wider">Misiones Hechas</p>
                        </div>
                        <div class="text-center">
                            <p id="proposed-automissions-count" class="text-1xl text-white">0</p>
                            <p class="text-xs text-slate-400 uppercase tracking-wider">Autom. Propuestas</p>
                        </div>
                        <div class="text-center">
                            <p id="completed-automissions-count" class="text-1xl text-white">0</p>
                            <p class="text-xs text-slate-400 uppercase tracking-wider">Autom. Hechas</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <section class="mb-6 fade-in">
            <div class="bg-slate-800 rounded-xl shadow-lg p-6 border border-slate-700">
                <div class="flex flex-wrap gap-4 items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-cyan-400">Añadir Misión</h2>
                    <button id="manage-categories-btn" class="text-sm bg-slate-700 hover:bg-slate-600 text-slate-300 font-semibold py-2 px-4 rounded-lg transition-colors duration-300">
                        <i class="fas fa-folder-plus mr-2"></i>Gestionar Categorías
                    </button>
                </div>
                <form id="add-mission-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
                    <div class="sm:col-span-2 lg:col-span-2">
                        <label for="mission-name" class="block text-sm font-medium text-slate-400 mb-1">Nombre Y Código</label>
                        <input type="text" id="mission-name" name="mission-name" required class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ej: Modelado de Asientos">
                    </div>
                    <div>
                        <label for="mission-points" class="block text-sm font-medium text-slate-400 mb-1">Puntos</label>
                        <input type="number" id="mission-points" name="mission-points" required min="1" class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Ej: 80">
                    </div>
                     <div>
                        <label for="mission-week" class="block text-sm font-medium text-slate-400 mb-1">Semana</label>
                        <select id="mission-week" name="mission-week" required class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 h-10">
                            <option value="" disabled selected>Elegir</option>
                            <!-- Opciones de semana se añaden con JS -->
                        </select>
                    </div>
                    <div>
                        <label for="mission-type" class="block text-sm font-medium text-slate-400 mb-1">Tipo</label>
                        <select id="mission-type" name="mission-type" required class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 h-10">
                            <option value="mision">Misión</option>
                            <option value="automision">Automisión</option>
                        </select>
                    </div>
                    <div>
                        <label for="mission-category" class="block text-sm font-medium text-slate-400 mb-1">Software</label>
                        <select id="mission-category" name="mission-category" required class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 h-10"></select>
                    </div>
                    <button type="submit" class="sm:col-span-2 lg:col-span-6 w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 h-10 mt-4">Añadir Misión</button>
                </form>
            </div>
        </section>
        
        <section class="mb-8 fade-in">
            <div class="bg-slate-800 rounded-xl shadow-lg p-6 border border-slate-700">
                <div id="filter-header" class="flex justify-between items-center cursor-pointer">
                    <h2 class="text-2xl font-bold text-cyan-400">Filtrar Misiones</h2>
                    <button id="filter-toggle-button" class="text-slate-400 hover:text-cyan-400 transition-colors duration-200"></button>
                </div>
                <div id="filter-content" class="mt-4 pt-4 border-t border-slate-700">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div>
                            <label for="search-input" class="block text-sm font-medium text-slate-400 mb-2">Buscar por nombre</label>
                            <input type="text" id="search-input" placeholder="Buscar misión..." class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                        </div>
                        <div>
                            <label for="filter-week" class="block text-sm font-medium text-slate-400 mb-2">Filtrar por Semana</label>
                            <select id="filter-week" name="filter-week" class="w-full bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 h-10">
                                <option value="all">Todas las semanas</option>
                                <!-- Opciones de semana se añaden con JS -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-2">Filtrar por Estado</label>
                            <div class="flex flex-wrap gap-2">
                                <button data-filter="all" class="filter-button bg-cyan-600 hover:bg-cyan-700 text-white text-sm font-medium py-1.5 px-3 rounded-full transition-colors duration-200">Todas</button>
                                <button data-filter="completed" class="filter-button bg-slate-600 hover:bg-slate-500 text-slate-300 text-sm font-medium py-1.5 px-3 rounded-full transition-colors duration-200">Realizadas</button>
                                <button data-filter="pending" class="filter-button bg-slate-600 hover:bg-slate-500 text-slate-300 text-sm font-medium py-1.5 px-3 rounded-full transition-colors duration-200">Pendientes</button>
                                <button data-filter="proposed" class="filter-button bg-slate-600 hover:bg-slate-500 text-slate-300 text-sm font-medium py-1.5 px-3 rounded-full transition-colors duration-200">Propuestas</button>
                            </div>
                        </div>
                        <!-- Filtro GES añadido -->
                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-2">Filtrar por GES</label>
                            <div class="flex flex-wrap gap-2">
                                <button data-filter-ges="all" class="ges-filter-button bg-cyan-600 hover:bg-cyan-700 text-white text-sm font-medium py-1.5 px-3 rounded-full transition-colors duration-200">Todos (GES)</button>
                                <button data-filter-ges="sent" class="ges-filter-button bg-slate-600 hover:bg-slate-500 text-slate-300 text-sm font-medium py-1.5 px-3 rounded-full transition-colors duration-200">Enviados</button>
                                <button data-filter-ges="not-sent" class="ges-filter-button bg-slate-600 hover:bg-slate-500 text-slate-300 text-sm font-medium py-1.5 px-3 rounded-full transition-colors duration-200">No Enviados</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <main id="categories-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></main>

        <footer class="text-center mt-12">
            <button id="reset-button" class="bg-red-900/50 hover:bg-red-900/80 text-red-300 font-semibold py-2 px-5 rounded-lg transition-colors duration-300">
                Reiniciar Progreso
            </button>
        </footer>
    </div>
    
    <!-- Modal para gestionar categorías -->
    <div id="category-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-slate-800 rounded-xl shadow-lg p-6 border border-slate-700 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-cyan-400">Gestionar Categorías</h3>
                <button id="close-modal-btn" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-2">Añadir Nueva Categoría</h4>
                <form id="add-category-form" class="flex gap-2">
                    <input type="text" id="new-category-name" placeholder="Nombre del software" class="flex-grow bg-slate-700 text-white border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                    <button type="submit" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">Añadir</button>
                </form>
            </div>
            <div>
                <h4 class="text-lg font-semibold text-white mb-2">Categorías Existentes</h4>
                <ul id="category-list" class="space-y-2 max-h-60 overflow-y-auto"></ul>
            </div>
        </div>
    </div>

    <script>
        const initialMissionData = { "Blender": [], "Figma": [], "SolidWorks": [] };
        let missionData;
        let categoryCollapseStates = JSON.parse(localStorage.getItem('categoryCollapseStates')) || {};
        let isFilterCollapsed = JSON.parse(localStorage.getItem('isFilterCollapsed')) || false;
        let currentFilter = { text: '', status: 'all', week: 'all', ges: 'all' };

        function loadProgress() {
            const savedData = localStorage.getItem('missionProgressData');
            missionData = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(initialMissionData));
            if (Object.keys(missionData).length === 0) {
                 missionData = JSON.parse(JSON.stringify(initialMissionData));
            }
        }

        function saveProgress() {
            localStorage.setItem('missionProgressData', JSON.stringify(missionData));
            localStorage.setItem('categoryCollapseStates', JSON.stringify(categoryCollapseStates));
            localStorage.setItem('isFilterCollapsed', JSON.stringify(isFilterCollapsed));
        }

        function animateScore(start, end) {
            const scoreElement = document.getElementById('total-score');
            if (start === end) {
                scoreElement.textContent = end;
                return;
            }
            const duration = 800;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.max(1, Math.abs(Math.floor(duration / range)));

            const timer = setInterval(() => {
                current += increment;
                scoreElement.textContent = current;
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        function updateScoresAndStats(animate = false, oldScore = 0) {
            const totalScoreElement = document.getElementById('total-score');
            const completedMissionsElement = document.getElementById('completed-missions-count');
            const proposedAutoMissionsElement = document.getElementById('proposed-automissions-count');
            const completedAutoMissionsElement = document.getElementById('completed-automissions-count');

            let totalPoints = 0, completedMissions = 0, proposedAutoMissions = 0, completedAutoMissions = 0;

            Object.values(missionData).flat().forEach(mission => {
                if (mission.type === 'automision') {
                    if (mission.status?.proposed) proposedAutoMissions++;
                    if (mission.status?.completed) {
                        completedAutoMissions++;
                        totalPoints += mission.points;
                    }
                } else if (mission.completed) {
                    completedMissions++;
                    totalPoints += mission.points;
                }
            });

            if (animate) {
                animateScore(oldScore, totalPoints);
            } else {
                totalScoreElement.textContent = totalPoints;
            }
            
            completedMissionsElement.textContent = completedMissions;
            proposedAutoMissionsElement.textContent = proposedAutoMissions;
            completedAutoMissionsElement.textContent = completedAutoMissions;
        }
        
        function renderMissions() {
            const container = document.getElementById('categories-container');
            container.innerHTML = ''; 

            Object.keys(missionData).sort().forEach(category => {
                const isCollapsed = categoryCollapseStates[category] || false;
                const categoryCard = document.createElement('div');
                categoryCard.className = 'category-card-bg rounded-xl shadow-lg p-6 border border-slate-700 fade-in flex flex-col'; // Añadido flex flex-col

                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'flex justify-between items-center mb-4 border-b border-slate-600 pb-3 cursor-pointer';
                categoryHeader.dataset.category = category;

                const categoryTitle = document.createElement('h2');
                categoryTitle.className = 'text-2xl font-bold text-cyan-400';
                categoryTitle.textContent = category;
                categoryHeader.appendChild(categoryTitle);

                const collapseToggle = document.createElement('button');
                collapseToggle.className = 'text-slate-400 hover:text-cyan-400 transition-colors duration-200';
                collapseToggle.innerHTML = isCollapsed ? '<i class="fas fa-chevron-down text-lg"></i>' : '<i class="fas fa-chevron-up text-lg"></i>';
                categoryHeader.appendChild(collapseToggle);
                categoryCard.appendChild(categoryHeader);

                const missionList = document.createElement('ul');
                missionList.className = `space-y-4 ${isCollapsed ? 'hidden' : ''} max-h-96 overflow-y-auto pr-2`; // Con scroll interno

                const filteredMissions = missionData[category].filter(mission => {
                    const matchesText = mission.name.toLowerCase().includes(currentFilter.text.toLowerCase());
                    let matchesStatus = true;
                    if (currentFilter.status === 'completed') matchesStatus = (mission.type === 'mision' && mission.completed) || (mission.type === 'automision' && mission.status?.completed);
                    else if (currentFilter.status === 'pending') matchesStatus = (mission.type === 'mision' && !mission.completed) || (mission.type === 'automision' && !mission.status?.completed);
                    else if (currentFilter.status === 'proposed') matchesStatus = mission.type === 'automision' && mission.status?.proposed;
                    
                    const matchesWeek = currentFilter.week === 'all' || mission.semana == currentFilter.week;
                    
                    const matchesGES = currentFilter.ges === 'all' || 
                                     (currentFilter.ges === 'sent' && mission.sentToGES) || 
                                     (currentFilter.ges === 'not-sent' && !mission.sentToGES);

                    return matchesText && matchesStatus && matchesWeek && matchesGES;
                });

                // Ordenar misiones filtradas por semana (como número)
                filteredMissions.sort((a, b) => parseInt(a.semana, 10) - parseInt(b.semana, 10));

                if (filteredMissions.length === 0) {
                    const emptyText = document.createElement('p');
                    emptyText.textContent = 'No hay misiones que coincidan con el filtro.';
                    emptyText.className = 'text-slate-500 italic py-2';
                    missionList.appendChild(emptyText);
                } else {
                    filteredMissions.forEach(mission => {
                        const originalIndex = missionData[category].indexOf(mission);
                        const missionItem = document.createElement('li');
                        missionItem.className = 'group relative p-4 bg-slate-800/50 rounded-lg border border-slate-700 hover:shadow-lg hover:border-cyan-600 transition-all duration-300 ease-in-out transform hover:scale-[1.01]';
                        missionItem.id = `mission-${category}-${originalIndex}`;

                        // --- Botones de Acción (Iconos) ---
                        const actionButtonsDiv = document.createElement('div');
                        actionButtonsDiv.className = 'absolute top-3 right-3 flex gap-3 opacity-0 group-hover:opacity-100 transition-all duration-300';
                        
                        // Botón de Nota
                        const noteIcon = document.createElement('button');
                        noteIcon.innerHTML = '<i class="fas fa-note-sticky"></i>';
                        noteIcon.className = `transition-colors duration-200 ${mission.note ? 'text-amber-400 hover:text-amber-300' : 'text-slate-500 hover:text-slate-300'}`;
                        noteIcon.dataset.action = 'toggle-note';
                        
                        // Botón de Eliminar
                        const deleteButton = document.createElement('button');
                        deleteButton.className = 'text-slate-500 hover:text-red-500 transition-all duration-300';
                        deleteButton.dataset.action = 'delete';
                        deleteButton.innerHTML = `<i class="fas fa-trash-alt text-base"></i>`;

                        actionButtonsDiv.append(noteIcon, deleteButton);
                        
                        // --- Editor de Notas ---
                        const noteEditor = document.createElement('div');
                        noteEditor.className = 'hidden mt-3';
                        noteEditor.innerHTML = `
                            <textarea class="w-full bg-slate-900 text-white border-slate-600 rounded-lg p-2 text-sm" rows="3" placeholder="Añade un link o tus pensamientos...">${mission.note || ''}</textarea>
                            <button data-action="save-note" class="mt-2 text-xs bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-1 px-3 rounded-full">Guardar Nota</button>
                        `;
                        
                        // --- Info de Misión ---
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'pr-14'; // Espacio para los botones de acción
                        
                        const missionNameContainer = document.createElement('div');
                        missionNameContainer.className = 'flex items-center gap-2 mb-1';
                        const missionIcon = document.createElement('i');
                        missionIcon.className = `text-lg ${mission.type === 'mision' ? 'fas fa-book text-emerald-400' : 'fas fa-lightbulb text-purple-400'}`;
                        const missionName = document.createElement('span');
                        missionName.textContent = mission.name;
                        missionName.className = 'font-semibold text-white leading-tight block';
                        missionNameContainer.append(missionIcon, missionName);

                        // --- Contenedor de Puntos y Semana ---
                        const detailsContainer = document.createElement('div');
                        detailsContainer.className = 'flex items-center gap-3 mt-1';

                        const missionPoints = document.createElement('span');
                        missionPoints.textContent = `+${mission.points} pts`;
                        missionPoints.className = 'text-amber-400 text-sm font-medium';
                        detailsContainer.appendChild(missionPoints);

                        // Selector de Semana en la tarjeta
                        const weekSelector = document.createElement('select');
                        weekSelector.className = 'week-select-card';
                        weekSelector.dataset.action = 'change-week';
                        weekSelector.dataset.category = category;
                        weekSelector.dataset.originalIndex = originalIndex;
                        
                        for (let i = 1; i <= 15; i++) {
                            const option = document.createElement('option');
                            option.value = i;
                            option.textContent = `Semana ${i}`;
                            weekSelector.appendChild(option);
                        }
                        weekSelector.value = mission.semana; // Establecer valor actual
                        detailsContainer.appendChild(weekSelector);
                        
                        infoDiv.append(missionNameContainer, detailsContainer);
                        
                        // --- Botones de Estado ---
                        const statusContainer = document.createElement('div');
                        statusContainer.className = 'flex items-center flex-wrap gap-2 mt-3';
                        if (mission.type === 'automision') {
                            const proposedButton = document.createElement('button');
                            proposedButton.dataset.statusType = 'proposed';
                            proposedButton.textContent = mission.status?.proposed ? 'Propuesta' : 'No Propuesta';
                            proposedButton.className = `text-xs font-bold py-1 px-3 rounded-full transition-colors duration-300 ${mission.status?.proposed ? 'bg-sky-700 text-sky-100 hover:bg-sky-600' : 'bg-slate-600 text-slate-300 hover:bg-slate-500'}`;
                            const completedButton = document.createElement('button');
                            completedButton.dataset.statusType = 'completed';
                            completedButton.textContent = mission.status?.completed ? 'Realizada' : 'Pendiente';
                            completedButton.className = `text-xs font-bold py-1 px-3 rounded-full transition-colors duration-300 ${mission.status?.completed ? 'bg-emerald-700 text-emerald-100 hover:bg-emerald-600' : 'bg-slate-600 text-slate-300 hover:bg-slate-500'}`;
                            statusContainer.append(proposedButton, completedButton);
                        } else {
                            const statusButton = document.createElement('button');
                            statusButton.textContent = mission.completed ? 'Realizado' : 'Pendiente';
                            statusButton.className = `text-xs font-bold py-1 px-3 rounded-full transition-colors duration-300 ${mission.completed ? 'bg-emerald-700 text-emerald-100 hover:bg-emerald-600' : 'bg-slate-600 text-slate-300 hover:bg-slate-500'}`;
                            statusContainer.appendChild(statusButton);
                        }
                        
                        // Botón de GES
                        const gesButton = document.createElement('button');
                        gesButton.dataset.statusType = 'ges';
                        gesButton.textContent = mission.sentToGES ? 'Enviado GES' : 'No Enviado';
                        gesButton.className = `text-xs font-bold py-1 px-3 rounded-full transition-colors duration-300 ${mission.sentToGES ? 'bg-indigo-700 text-indigo-100 hover:bg-indigo-600' : 'bg-slate-600 text-slate-300 hover:bg-slate-500'}`;
                        statusContainer.appendChild(gesButton);

                        missionItem.append(infoDiv, statusContainer, noteEditor, actionButtonsDiv);
                        missionList.appendChild(missionItem);
                    });
                }
                categoryCard.appendChild(missionList);
                container.appendChild(categoryCard);
            });
            updateScoresAndStats();
            populateCategorySelector();
            populateWeekSelectors();
        }

        function populateCategorySelector() {
            const selector = document.getElementById('mission-category');
            const currentVal = selector.value;
            selector.innerHTML = '<option value="" disabled>Elige un software</option>';
            Object.keys(missionData).sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                selector.appendChild(option);
            });
            selector.value = currentVal;
            if(!selector.value) selector.selectedIndex = 0;
        }

        function populateWeekSelectors() {
            const selectors = [document.getElementById('mission-week'), document.getElementById('filter-week')];
            selectors.forEach((selector, index) => {
                const currentVal = selector.value;
                if (index === 0) { // Formulario de añadir
                    selector.innerHTML = '<option value="" disabled>Elegir</option>';
                } else { // Filtro
                    selector.innerHTML = '<option value="all">Todas las semanas</option>';
                }
                for (let i = 1; i <= 15; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Semana ${i}`;
                    selector.appendChild(option);
                }
                selector.value = currentVal;
                if(!selector.value) selector.selectedIndex = 0;
            });
        }

        function setupFilterCollapse() {
            const filterHeader = document.getElementById('filter-header');
            const filterContent = document.getElementById('filter-content');
            const filterToggleButton = document.getElementById('filter-toggle-button');
            function updateFilterView() {
                filterContent.classList.toggle('hidden', isFilterCollapsed);
                filterToggleButton.innerHTML = isFilterCollapsed ? '<i class="fas fa-chevron-down text-lg"></i>' : '<i class="fas fa-chevron-up text-lg"></i>';
            }
            updateFilterView();
            filterHeader.addEventListener('click', () => { isFilterCollapsed = !isFilterCollapsed; saveProgress(); updateFilterView(); });
        }
        
        // --- CATEGORY MANAGEMENT (LÓGICA RESTAURADA) ---
        const modal = document.getElementById('category-modal');
        const manageCategoriesBtn = document.getElementById('manage-categories-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const addCategoryForm = document.getElementById('add-category-form');
        const categoryList = document.getElementById('category-list');
        
        function renderCategoryList() {
            categoryList.innerHTML = '';
            Object.keys(missionData).sort().forEach(cat => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-slate-700 p-2 rounded-lg';
                li.innerHTML = `<span>${cat}</span><button data-cat-delete="${cat}" class="text-red-500 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>`;
                categoryList.appendChild(li);
            });
        }
        
        manageCategoriesBtn.addEventListener('click', () => { modal.classList.remove('hidden'); renderCategoryList(); });
        closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
        
        addCategoryForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('new-category-name');
            const newName = input.value.trim();
            if (newName && !missionData[newName]) {
                missionData[newName] = [];
                saveProgress();
                renderCategoryList();
                populateCategorySelector();
                renderMissions();
                input.value = '';
            } else { alert('El nombre de la categoría no es válido o ya existe.'); }
        });
        
        categoryList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('button[data-cat-delete]');
            if (deleteBtn) {
                const catToDelete = deleteBtn.dataset.catDelete;
                if (confirm(`¿Seguro que quieres eliminar la categoría "${catToDelete}" y todas sus misiones?`)) {
                    delete missionData[catToDelete];
                    delete categoryCollapseStates[catToDelete]; // También borrar estado de colapso
                    saveProgress();
                    renderCategoryList();
                    populateCategorySelector();
                    renderMissions();
                }
            }
        });
        // --- FIN DE CATEGORY MANAGEMENT ---


        // --- EVENT HANDLERS ---
        
        // Listener para CAMBIOS (Select de semana en tarjeta)
        document.getElementById('categories-container').addEventListener('change', function(e) {
            if (e.target.dataset.action === 'change-week') {
                const selector = e.target;
                const category = selector.dataset.category;
                const originalIndex = parseInt(selector.dataset.originalIndex, 10);
                
                // Buscar el índice real en missionData
                const missionItem = selector.closest('li');
                const missionName = missionItem.querySelector('span.font-semibold').textContent;
                const realIndex = missionData[category].findIndex(m => m.name === missionName);

                if (realIndex !== -1) {
                    const newWeek = parseInt(selector.value, 10);
                    missionData[category][realIndex].semana = newWeek;
                    saveProgress();
                    renderMissions(); // Re-render to re-sort
                } else {
                    console.error("No se pudo encontrar el índice real de la misión para cambiar semana.");
                }
            }
        });

        // Listener para CLICKS (Botones de estado, notas, eliminar, etc.)
        document.getElementById('categories-container').addEventListener('click', function(e) {
            // Ignorar clicks en el selector de semana
            if (e.target.dataset.action === 'change-week') {
                return;
            }

            const clickable = e.target.closest('button, div[data-category]');
            if (!clickable) return;

            const missionItem = clickable.closest('li');
            const category = missionItem?.parentElement.parentElement.querySelector('[data-category]').dataset.category;
            
            // Handle category collapse
            if (clickable.dataset.category && !missionItem) {
                categoryCollapseStates[clickable.dataset.category] = !categoryCollapseStates[clickable.dataset.category];
                saveProgress(); renderMissions(); return;
            }

            if (!missionItem) return;

            // Encontrar el índice original de forma segura
            const missionName = missionItem.querySelector('span.font-semibold').textContent;
            const originalIndex = missionData[category].findIndex(m => m.name === missionName);
            
            if (originalIndex === -1) {
                console.error("No se pudo encontrar el índice original de la misión.");
                return; 
            }

            const mission = missionData[category][originalIndex];
            
            // Handle Note actions
            if (clickable.dataset.action === 'toggle-note') {
                missionItem.querySelector('div.hidden')?.classList.remove('hidden');
                clickable.classList.add('hidden'); // Ocultar ícono al abrir
            } else if (clickable.dataset.action === 'save-note') {
                const textarea = missionItem.querySelector('textarea');
                mission.note = textarea.value;
                saveProgress();
                textarea.parentElement.classList.add('hidden');
                missionItem.querySelector('button[data-action="toggle-note"]').classList.remove('hidden'); // Mostrar ícono
                renderMissions(); // to update note icon color
            } else if (clickable.dataset.action === 'delete') {
                if (confirm('¿Seguro que quieres eliminar esta misión?')) {
                    missionData[category].splice(originalIndex, 1);
                    saveProgress(); renderMissions();
                }
            } else if (clickable.dataset.statusType || clickable.textContent === 'Pendiente' || clickable.textContent === 'Realizado') { // Status change
                const oldScore = parseInt(document.getElementById('total-score').textContent, 10);
                let completed = false;
                const type = clickable.dataset.statusType;
                let missionJustCompleted = false;

                if (type === 'ges') {
                    mission.sentToGES = !mission.sentToGES;
                } else if (mission.type === 'automision') {
                    if (type === 'completed' && !mission.status[type]) missionJustCompleted = true;
                    mission.status[type] = !mission.status[type];
                    completed = mission.status.completed;
                } else if (mission.type === 'mision') {
                    if (type !== 'proposed') { 
                        if (!mission.completed) missionJustCompleted = true;
                        mission.completed = !mission.completed;
                        completed = mission.completed;
                    }
                }
                
                // Lógica de animación unificada
                if (missionJustCompleted) {
                    const pointsCelebration = document.createElement('span');
                    pointsCelebration.className = 'points-celebration text-amber-300 font-bold text-lg';
                    pointsCelebration.textContent = `+${mission.points}`;
                    missionItem.appendChild(pointsCelebration);
                    missionItem.classList.add('mission-completed-glow');
                    setTimeout(() => pointsCelebration.remove(), 1200);
                    setTimeout(() => missionItem.classList.remove('mission-completed-glow'), 800);
                }

                saveProgress();
                updateScoresAndStats(true, oldScore);
                setTimeout(renderMissions, 1300); // Retraso mayor para la animación
            }
        });
        
        document.getElementById('reset-button').addEventListener('click', () => {
            if (confirm('¿Seguro? Se borrará todo tu progreso.')) {
                localStorage.clear();
                loadProgress();
                categoryCollapseStates = {};
                isFilterCollapsed = false;
                renderMissions();
                setupFilterCollapse();
            }
        });
        
        document.getElementById('add-mission-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const name = form.elements['mission-name'].value.trim();
            const points = parseInt(form.elements['mission-points'].value, 10);
            const semana = parseInt(form.elements['mission-week'].value, 10);
            const type = form.elements['mission-type'].value;
            const category = form.elements['mission-category'].value;

            if (name && points > 0 && semana && category && type) {
                const newMission = { name, points, semana, type, note: '', sentToGES: false };
                if (type === 'automision') newMission.status = { proposed: false, completed: false };
                else newMission.completed = false;
                
                missionData[category].push(newMission);
                saveProgress();
                renderMissions();
                form.reset();
                // Dejar categoría seleccionada
                form.elements['mission-category'].value = category;
            } else { alert('Completa todos los campos correctamente, incluyendo la semana.'); }
        });
        
        document.getElementById('search-input').addEventListener('input', (e) => { currentFilter.text = e.target.value; renderMissions(); });
        
        document.getElementById('filter-week').addEventListener('input', (e) => {
            currentFilter.week = e.target.value;
            renderMissions();
        });

        document.querySelectorAll('.filter-button').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelector('.filter-button.bg-cyan-600')?.classList.replace('bg-cyan-600', 'bg-slate-600');
                document.querySelector('.filter-button.text-white')?.classList.replace('text-white', 'text-slate-300');
                e.target.classList.replace('bg-slate-600', 'bg-cyan-600');
                e.target.classList.replace('text-slate-300', 'text-white');
                currentFilter.status = e.target.dataset.filter;
                renderMDissions();
            });
        });

        // Listener para filtros de GES
        document.querySelectorAll('.ges-filter-button').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelector('.ges-filter-button.bg-cyan-600')?.classList.replace('bg-cyan-600', 'bg-slate-600');
                document.querySelector('.ges-filter-button.text-white')?.classList.replace('text-white', 'text-slate-300');
                e.target.classList.replace('bg-slate-600', 'bg-cyan-600');
                e.target.classList.replace('text-slate-300', 'text-white');
                currentFilter.ges = e.target.dataset.filterGes;
                renderMissions();
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadProgress();
            renderMissions();
            setupFilterCollapse();
            // Activar botón "Todas" por defecto
            document.querySelector('.filter-button[data-filter="all"]')?.classList.replace('bg-slate-600', 'bg-cyan-600');
            document.querySelector('.filter-button[data-filter="all"]')?.classList.replace('text-slate-300', 'text-white');
            // Activar botón "Todos (GES)" por defecto
            document.querySelector('.ges-filter-button[data-filter-ges="all"]')?.classList.replace('bg-slate-600', 'bg-cyan-600');
            document.querySelector('.ges-filter-button[data-filter-ges="all"]')?.classList.replace('text-slate-300', 'text-white');
        });
    </script>
</body>
</html>

